<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Higher Ed Market Intelligence | IPEDS 2024</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--ink:#1a1a2e;--ink-light:#2d2d44;--cream:#faf8f5;--cream-dark:#f0ede8;--accent:#c45d3a;--accent-light:#e8d5c4;--sea:#2d5a7b;--sea-light:#4a8db7;--gold:#d4a574}
        body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;overflow:hidden}
        .app-container{display:grid;grid-template-rows:auto 1fr;height:100vh}
        header{background:var(--ink);color:var(--cream);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid var(--accent)}
        .logo{display:flex;align-items:baseline;gap:1rem}
        .logo h1{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700}
        .logo span{font-size:.65rem;text-transform:uppercase;letter-spacing:.15em;color:var(--gold);font-weight:600}
        .header-stats{display:flex;gap:2rem;align-items:center}
        .stat{text-align:right}
        .stat-value{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600;color:var(--gold)}
        .stat-label{font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;opacity:.7}
        .main-content{display:grid;grid-template-columns:360px 1fr;height:100%;overflow:hidden}
        .sidebar{background:#fff;border-right:1px solid rgba(0,0,0,.08);display:flex;flex-direction:column;overflow:hidden}
        .sidebar-tabs{display:flex;border-bottom:1px solid rgba(0,0,0,.08)}
        .sidebar-tab{flex:1;padding:.8rem;background:none;border:none;font-family:inherit;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#666;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
        .sidebar-tab:hover{color:var(--ink)}
        .sidebar-tab.active{color:var(--sea);border-bottom-color:var(--sea)}
        .tab-content{display:none;flex-direction:column;flex:1;overflow:hidden}
        .tab-content.active{display:flex}
        .search-section{padding:1rem;border-bottom:1px solid rgba(0,0,0,.06);background:linear-gradient(to bottom,#fff,#fafafa)}
        .search-box{position:relative}
        .search-box input{width:100%;padding:.7rem 1rem .7rem 2.4rem;border:2px solid rgba(0,0,0,.08);border-radius:8px;font-family:inherit;font-size:.8rem;background:#fff;transition:all .2s}
        .search-box input:focus{outline:none;border-color:var(--sea);box-shadow:0 0 0 3px rgba(45,90,123,.1)}
        .search-box::before{content:"âŒ•";position:absolute;left:.8rem;top:50%;transform:translateY(-50%);font-size:1rem;opacity:.4}
        .bubble-controls{padding:1rem;border-bottom:1px solid rgba(0,0,0,.06);background:var(--cream-dark)}
        .bubble-toggle{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}
        .toggle-switch{position:relative;width:44px;height:24px;background:#ccc;border-radius:12px;cursor:pointer;transition:background .3s}
        .toggle-switch.active{background:var(--sea)}
        .toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
        .toggle-switch.active::after{transform:translateX(20px)}
        .toggle-label{font-size:.8rem;font-weight:600}
        .bubble-metric-select{width:100%;padding:.55rem .7rem;border:1px solid rgba(0,0,0,.12);border-radius:6px;font-family:inherit;font-size:.75rem;background:#fff}
        .filters-panel{flex:1;overflow-y:auto;padding:1rem}
        .filter-group{margin-bottom:1.1rem}
        .filter-group-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
        .filter-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#666}
        .filter-clear{font-size:.65rem;color:var(--accent);background:none;border:none;cursor:pointer;font-family:inherit}
        .filter-options{display:flex;flex-wrap:wrap;gap:.35rem}
        .filter-btn{padding:.35rem .65rem;border:1px solid rgba(0,0,0,.12);border-radius:14px;background:#fff;font-family:inherit;font-size:.65rem;font-weight:500;cursor:pointer;transition:all .2s;color:var(--ink)}
        .filter-btn:hover{border-color:var(--sea);color:var(--sea)}
        .filter-btn.active{background:var(--sea);color:#fff;border-color:var(--sea)}
        .filter-select{width:100%;padding:.45rem .65rem;border:1px solid rgba(0,0,0,.12);border-radius:6px;font-family:inherit;font-size:.75rem;background:#fff;cursor:pointer}
        .filter-select:focus{outline:none;border-color:var(--sea)}
        .range-slider-container{padding:.4rem 0}
        .range-values{display:flex;justify-content:space-between;font-size:.7rem;color:#666;margin-bottom:.2rem}
        .range-slider{width:100%;height:4px;-webkit-appearance:none;background:#e0e0e0;border-radius:2px;outline:none}
        .range-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--sea);border-radius:50%;cursor:pointer}
        .results-header{padding:.7rem 1rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,.06);background:#fff}
        .results-count{font-size:.7rem;color:#666}
        .results-count strong{color:var(--ink);font-weight:600}
        .export-btn{padding:.35rem .7rem;background:var(--ink);color:#fff;border:none;border-radius:4px;font-family:inherit;font-size:.65rem;font-weight:500;cursor:pointer;transition:background .2s}
        .export-btn:hover{background:var(--ink-light)}
        .results-list{flex:1;overflow-y:auto;padding:.4rem}
        .result-item{padding:.8rem;border-radius:6px;cursor:pointer;transition:all .2s;border:1px solid transparent;margin-bottom:.2rem}
        .result-item:hover{background:var(--accent-light);border-color:var(--accent)}
        .result-name{font-weight:600;font-size:.8rem;margin-bottom:.15rem;line-height:1.3}
        .result-location{font-size:.65rem;opacity:.7}
        .result-meta{display:flex;gap:.4rem;margin-top:.35rem;flex-wrap:wrap;align-items:center}
        .result-tag{display:inline-block;padding:.12rem .35rem;background:rgba(0,0,0,.06);border-radius:3px;font-size:.55rem;text-transform:uppercase;letter-spacing:.03em;font-weight:600}
        .result-enrollment{font-size:.65rem;color:var(--sea);font-weight:600}
        .map-container{position:relative}
        #map{width:100%;height:100%;background:#e8e4dc}
        .map-legend{position:absolute;bottom:1.5rem;right:1.5rem;background:#fff;padding:.9rem;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.12);z-index:1000;font-size:.65rem;min-width:150px}
        .legend-title{font-weight:600;margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em;font-size:.6rem;color:#666}
        .legend-item{display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem}
        .legend-dot{width:10px;height:10px;border-radius:50%}
        .legend-dot.public{background:#2d5a7b}
        .legend-dot.private-np{background:#c45d3a}
        .legend-dot.private-fp{background:#d4a574}
        .bubble-legend{margin-top:.65rem;padding-top:.65rem;border-top:1px solid rgba(0,0,0,.08)}
        .bubble-scale{display:flex;align-items:flex-end;gap:.4rem;margin-top:.4rem}
        .bubble-scale-item{display:flex;flex-direction:column;align-items:center;gap:.2rem}
        .bubble-circle{background:rgba(45,90,123,.3);border:2px solid var(--sea);border-radius:50%}
        .bubble-label{font-size:.55rem;color:#666}
        .market-summary{position:absolute;top:1rem;left:1rem;background:#fff;padding:.9rem;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.12);z-index:1000;min-width:200px}
        .summary-title{font-weight:600;font-size:.65rem;text-transform:uppercase;letter-spacing:.05em;color:#666;margin-bottom:.65rem}
        .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
        .summary-stat{text-align:center;padding:.4rem;background:var(--cream);border-radius:4px}
        .summary-stat-value{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;color:var(--ink)}
        .summary-stat-label{font-size:.55rem;color:#666;text-transform:uppercase;letter-spacing:.03em}
        .leaflet-popup-content-wrapper{border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:0;overflow:hidden}
        .leaflet-popup-content{margin:0;min-width:260px}
        .popup-header{background:var(--ink);color:#fff;padding:.8rem .9rem}
        .popup-header h3{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:600;margin-bottom:.15rem;line-height:1.3}
        .popup-header p{font-size:.7rem;opacity:.8}
        .popup-body{padding:.8rem .9rem}
        .popup-section{margin-bottom:.65rem}
        .popup-section:last-child{margin-bottom:0}
        .popup-section-title{font-size:.6rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#666;margin-bottom:.3rem}
        .popup-stats{display:grid;grid-template-columns:1fr 1fr;gap:.4rem}
        .popup-stat{text-align:center;padding:.35rem;background:var(--cream);border-radius:4px}
        .popup-stat-value{font-size:.85rem;font-weight:700;color:var(--ink)}
        .popup-stat-label{font-size:.55rem;color:#666}
        .popup-tags{display:flex;flex-wrap:wrap;gap:.2rem}
        .popup-tag{padding:.15rem .4rem;background:rgba(45,90,123,.1);color:var(--sea);border-radius:3px;font-size:.6rem;font-weight:500}
        .popup-link{display:block;margin-top:.65rem;padding:.5rem;background:var(--sea);color:#fff;text-align:center;text-decoration:none;border-radius:5px;font-size:.75rem;font-weight:500;transition:background .2s}
        .popup-link:hover{background:var(--sea-light)}
        .marker-cluster-small{background-color:rgba(45,90,123,.6)}
        .marker-cluster-small div{background-color:rgba(45,90,123,.8)}
        .marker-cluster-medium{background-color:rgba(196,93,58,.6)}
        .marker-cluster-medium div{background-color:rgba(196,93,58,.8)}
        .marker-cluster-large{background-color:rgba(26,26,46,.6)}
        .marker-cluster-large div{background-color:rgba(26,26,46,.8)}
        .marker-cluster{background-clip:padding-box;border-radius:50%}
        .marker-cluster div{width:30px;height:30px;margin-left:5px;margin-top:5px;text-align:center;border-radius:50%;font:11px 'DM Sans',sans-serif;font-weight:600;color:#fff;display:flex;align-items:center;justify-content:center}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--ink);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s,visibility .5s}
        .loading-overlay.hidden{opacity:0;visibility:hidden}
        .loading-spinner{width:50px;height:50px;border:3px solid rgba(255,255,255,.1);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite}
        .loading-text{margin-top:1.2rem;color:var(--cream);font-family:'Playfair Display',serif;font-size:1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .no-results{text-align:center;padding:2rem 1rem;color:#666}
        .no-results-icon{font-size:2rem;margin-bottom:.5rem;opacity:.3}
        @media(max-width:900px){.main-content{grid-template-columns:1fr}.sidebar{display:none}}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Market Data...</div>
    </div>

    <div class="app-container">
        <header>
            <div class="logo">
                <h1>Higher Ed Market Intelligence</h1>
                <span>IPEDS 2024 â€¢ Digital Marketing</span>
            </div>
            <div class="header-stats">
                <div class="stat">
                    <div class="stat-value" id="totalCount">â€”</div>
                    <div class="stat-label">Institutions</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalEnrollment">â€”</div>
                    <div class="stat-label">Total Enrollment</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stateCount">â€”</div>
                    <div class="stat-label">States</div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="filters">Filters</button>
                    <button class="sidebar-tab" data-tab="results">Results</button>
                </div>

                <div class="tab-content active" id="filters-tab">
                    <div class="search-section">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Search name, city, or state...">
                        </div>
                    </div>

                    <div class="bubble-controls">
                        <div class="bubble-toggle">
                            <div class="toggle-switch" id="bubbleToggle"></div>
                            <span class="toggle-label">Bubble Map View</span>
                        </div>
                        <select class="bubble-metric-select" id="bubbleMetric" disabled>
                            <option value="ENRTOT">Total Enrollment</option>
                            <option value="FTE">Full-Time Equivalent (FTE)</option>
                            <option value="EFUG">Undergraduate Enrollment</option>
                            <option value="EFGRAD">Graduate Enrollment</option>
                            <option value="CSTOTLT">Total Completions/Graduates</option>
                            <option value="TUITION1">In-State Tuition</option>
                            <option value="TUITION2">Out-of-State Tuition</option>
                        </select>
                    </div>

                    <div class="filters-panel">
                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Institution Type</span>
                                <button class="filter-clear" data-filter="control">Clear</button>
                            </div>
                            <div class="filter-options" id="controlFilters">
                                <button class="filter-btn" data-filter="control" data-value="1">Public</button>
                                <button class="filter-btn" data-filter="control" data-value="2">Private Non-Profit</button>
                                <button class="filter-btn" data-filter="control" data-value="3">Private For-Profit</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Highest Degree Offered</span>
                                <button class="filter-clear" data-filter="degree">Clear</button>
                            </div>
                            <div class="filter-options" id="degreeFilters">
                                <button class="filter-btn" data-filter="degree" data-value="doctoral">Doctoral</button>
                                <button class="filter-btn" data-filter="degree" data-value="masters">Master's</button>
                                <button class="filter-btn" data-filter="degree" data-value="bachelors">Bachelor's</button>
                                <button class="filter-btn" data-filter="degree" data-value="associates">Associate's</button>
                                <button class="filter-btn" data-filter="degree" data-value="certificate">Certificate</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Locale Setting</span>
                                <button class="filter-clear" data-filter="locale">Clear</button>
                            </div>
                            <div class="filter-options" id="localeFilters">
                                <button class="filter-btn" data-filter="locale" data-value="city">City</button>
                                <button class="filter-btn" data-filter="locale" data-value="suburb">Suburb</button>
                                <button class="filter-btn" data-filter="locale" data-value="town">Town</button>
                                <button class="filter-btn" data-filter="locale" data-value="rural">Rural</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Institution Size</span>
                                <button class="filter-clear" data-filter="size">Clear</button>
                            </div>
                            <div class="filter-options" id="sizeFilters">
                                <button class="filter-btn" data-filter="size" data-value="1">Under 1K</button>
                                <button class="filter-btn" data-filter="size" data-value="2">1K-5K</button>
                                <button class="filter-btn" data-filter="size" data-value="3">5K-10K</button>
                                <button class="filter-btn" data-filter="size" data-value="4">10K-20K</button>
                                <button class="filter-btn" data-filter="size" data-value="5">20K+</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Special Designations</span>
                                <button class="filter-clear" data-filter="special">Clear</button>
                            </div>
                            <div class="filter-options" id="specialFilters">
                                <button class="filter-btn" data-filter="special" data-value="hbcu">HBCU</button>
                                <button class="filter-btn" data-filter="special" data-value="tribal">Tribal</button>
                                <button class="filter-btn" data-filter="special" data-value="landgrant">Land Grant</button>
                                <button class="filter-btn" data-filter="special" data-value="medical">Medical</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Carnegie Classification</span>
                                <button class="filter-clear" data-filter="carnegie">Clear</button>
                            </div>
                            <div class="filter-options" id="carnegieFilters">
                                <button class="filter-btn" data-filter="carnegie" data-value="r1">R1 Research</button>
                                <button class="filter-btn" data-filter="carnegie" data-value="r2">R2 Research</button>
                                <button class="filter-btn" data-filter="carnegie" data-value="masters">Master's</button>
                                <button class="filter-btn" data-filter="carnegie" data-value="bacc">Baccalaureate</button>
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">State / Region</span>
                                <button class="filter-clear" data-filter="state">Clear</button>
                            </div>
                            <select class="filter-select" id="stateFilter">
                                <option value="">All States & Territories</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Minimum Enrollment</span>
                            </div>
                            <div class="range-slider-container">
                                <div class="range-values">
                                    <span>0</span>
                                    <span id="enrollmentValue">0</span>
                                </div>
                                <input type="range" class="range-slider" id="enrollmentSlider" min="0" max="50000" step="500" value="0">
                            </div>
                        </div>

                        <div class="filter-group">
                            <div class="filter-group-header">
                                <span class="filter-label">Minimum Completions</span>
                            </div>
                            <div class="range-slider-container">
                                <div class="range-values">
                                    <span>0</span>
                                    <span id="completionsValue">0</span>
                                </div>
                                <input type="range" class="range-slider" id="completionsSlider" min="0" max="10000" step="100" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="results-tab">
                    <div class="results-header">
                        <span class="results-count">Showing <strong id="visibleCount">0</strong> institutions</span>
                        <button class="export-btn" id="exportBtn">Export CSV</button>
                    </div>
                    <div class="results-list" id="resultsList"></div>
                </div>
            </aside>

            <main class="map-container">
                <div id="map"></div>
                
                <div class="market-summary" id="marketSummary">
                    <div class="summary-title">Filtered Market Summary</div>
                    <div class="summary-grid">
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryInstitutions">â€”</div>
                            <div class="summary-stat-label">Institutions</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryEnrollment">â€”</div>
                            <div class="summary-stat-label">Students</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryPublic">â€”</div>
                            <div class="summary-stat-label">Public</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryPrivate">â€”</div>
                            <div class="summary-stat-label">Private</div>
                        </div>
                    </div>
                </div>

                <div class="map-legend" id="mapLegend">
                    <div class="legend-title">Institution Type</div>
                    <div class="legend-item">
                        <div class="legend-dot public"></div>
                        <span>Public</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot private-np"></div>
                        <span>Private Non-Profit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot private-fp"></div>
                        <span>Private For-Profit</span>
                    </div>
                    <div class="bubble-legend" id="bubbleLegend" style="display:none">
                        <div class="legend-title" id="bubbleLegendTitle">Enrollment Size</div>
                        <div class="bubble-scale">
                            <div class="bubble-scale-item">
                                <div class="bubble-circle" style="width:10px;height:10px"></div>
                                <span class="bubble-label" id="bubbleMin">1K</span>
                            </div>
                            <div class="bubble-scale-item">
                                <div class="bubble-circle" style="width:22px;height:22px"></div>
                                <span class="bubble-label" id="bubbleMid">25K</span>
                            </div>
                            <div class="bubble-scale-item">
                                <div class="bubble-circle" style="width:36px;height:36px"></div>
                                <span class="bubble-label" id="bubbleMax">50K+</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    // Data storage
    let universities = [], enrollmentData = {}, completionsData = {}, costData = {};
    let bubbleMode = false;

    // Map setup
    const map = L.map('map', {zoomControl: true}).setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap Â© CARTO',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 10
    });
    const bubbleLayer = L.layerGroup();

    // Filter state
    const filters = {
        search: '',
        control: [],
        degree: [],
        locale: [],
        size: [],
        special: [],
        carnegie: [],
        state: '',
        minEnrollment: 0,
        minCompletions: 0
    };

    // Utility functions
    function parseCSV(csv) {
        const lines = csv.trim().split('\n');
        const headers = lines[0].split(',');
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = [];
            let current = '', inQuotes = false;
            for (let char of lines[i]) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { values.push(current.trim()); current = ''; }
                else current += char;
            }
            values.push(current.trim());
            if (values.length === headers.length) {
                const obj = {};
                headers.forEach((h, idx) => obj[h] = values[idx]);
                data.push(obj);
            }
        }
        return data;
    }

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function formatCurrency(num) { return '$' + num.toLocaleString(); }

    function getColor(control) {
        switch(parseInt(control)) {
            case 1: return '#2d5a7b';
            case 2: return '#c45d3a';
            case 3: return '#d4a574';
            default: return '#666';
        }
    }

    function getControlType(control) {
        switch(parseInt(control)) {
            case 1: return 'Public';
            case 2: return 'Private NP';
            case 3: return 'Private FP';
            default: return 'Unknown';
        }
    }

    function getDegreeLevel(code) {
        const c = parseInt(code);
        if (c >= 11 && c <= 12) return 'doctoral';
        if (c >= 13 && c <= 14) return 'masters';
        if (c >= 20 && c <= 23) return 'bachelors';
        if (c >= 30 && c <= 40) return 'associates';
        return 'certificate';
    }

    function getDegreeName(code) {
        const c = parseInt(code);
        if (c >= 11 && c <= 12) return 'Doctoral';
        if (c >= 13 && c <= 14) return "Master's";
        if (c >= 20 && c <= 23) return "Bachelor's";
        if (c >= 30 && c <= 40) return "Associate's";
        return 'Certificate';
    }

    function getLocaleCategory(locale) {
        const l = parseInt(locale);
        if (l >= 11 && l <= 13) return 'city';
        if (l >= 21 && l <= 23) return 'suburb';
        if (l >= 31 && l <= 33) return 'town';
        if (l >= 41 && l <= 43) return 'rural';
        return 'unknown';
    }

    function getLocaleName(locale) {
        const l = parseInt(locale);
        if (l === 11) return 'City: Large';
        if (l === 12) return 'City: Midsize';
        if (l === 13) return 'City: Small';
        if (l === 21) return 'Suburb: Large';
        if (l === 22) return 'Suburb: Midsize';
        if (l === 23) return 'Suburb: Small';
        if (l === 31) return 'Town: Fringe';
        if (l === 32) return 'Town: Distant';
        if (l === 33) return 'Town: Remote';
        if (l === 41) return 'Rural: Fringe';
        if (l === 42) return 'Rural: Distant';
        if (l === 43) return 'Rural: Remote';
        return 'Unknown';
    }

    function getCarnegieCategory(c21) {
        const c = parseInt(c21);
        if (c === 15) return 'r1';
        if (c === 16) return 'r2';
        if (c >= 17 && c <= 19) return 'masters';
        if (c >= 21 && c <= 23) return 'bacc';
        return 'other';
    }

    function getEnrichedData(uni) {
        const unitid = uni.UNITID;
        const enrollment = enrollmentData[unitid] || {};
        const completions = completionsData[unitid] || {};
        const cost = costData[unitid] || {};
        return {
            ...uni,
            ENRTOT: parseInt(enrollment.ENRTOT) || 0,
            FTE: parseInt(enrollment.FTE) || 0,
            EFUG: parseInt(enrollment.EFUG) || 0,
            EFGRAD: parseInt(enrollment.EFGRAD) || 0,
            PCTENRW: parseInt(enrollment.PCTENRW) || 0,
            CSTOTLT: parseInt(completions.CSTOTLT) || 0,
            TUITION1: parseFloat(cost.TUITION1) || 0,
            TUITION2: parseFloat(cost.TUITION2) || 0,
            RMBRDAMT: parseFloat(cost.RMBRDAMT) || 0
        };
    }

    // Filtering
    function matchesFilters(uni) {
        const data = getEnrichedData(uni);
        
        if (filters.search) {
            const q = filters.search.toLowerCase();
            const name = (uni.INSTNM || '').toLowerCase();
            const city = (uni.CITY || '').toLowerCase();
            const state = (uni.STABBR || '').toLowerCase();
            if (!name.includes(q) && !city.includes(q) && !state.includes(q)) return false;
        }
        
        if (filters.control.length > 0 && !filters.control.includes(uni.CONTROL)) return false;
        
        if (filters.degree.length > 0) {
            const deg = getDegreeLevel(uni.HDEGOFR1);
            if (!filters.degree.includes(deg)) return false;
        }
        
        if (filters.locale.length > 0) {
            const loc = getLocaleCategory(uni.LOCALE);
            if (!filters.locale.includes(loc)) return false;
        }
        
        if (filters.size.length > 0 && !filters.size.includes(uni.INSTSIZE)) return false;
        
        if (filters.special.length > 0) {
            let matched = false;
            for (const s of filters.special) {
                if (s === 'hbcu' && uni.HBCU === '1') matched = true;
                if (s === 'tribal' && uni.TRIBAL === '1') matched = true;
                if (s === 'landgrant' && uni.LANDGRNT === '1') matched = true;
                if (s === 'medical' && uni.MEDICAL === '1') matched = true;
            }
            if (!matched) return false;
        }
        
        if (filters.carnegie.length > 0) {
            const carn = getCarnegieCategory(uni.C21BASIC);
            if (!filters.carnegie.includes(carn)) return false;
        }
        
        if (filters.state && uni.STABBR !== filters.state) return false;
        if (filters.minEnrollment > 0 && data.ENRTOT < filters.minEnrollment) return false;
        if (filters.minCompletions > 0 && data.CSTOTLT < filters.minCompletions) return false;
        
        return true;
    }

    // Markers
    function createMarker(uni) {
        const lat = parseFloat(uni.LATITUDE);
        const lng = parseFloat(uni.LONGITUD);
        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return null;
        
        const color = getColor(uni.CONTROL);
        const data = getEnrichedData(uni);
        
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="width:10px;height:10px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,.3)"></div>`,
            iconSize: [10, 10],
            iconAnchor: [5, 5]
        });

        const marker = L.marker([lat, lng], { icon });
        marker.bindPopup(createPopupContent(uni, data), { maxWidth: 300 });
        marker.universityData = uni;
        return marker;
    }

    function createBubbleMarker(uni) {
        const lat = parseFloat(uni.LATITUDE);
        const lng = parseFloat(uni.LONGITUD);
        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return null;
        
        const data = getEnrichedData(uni);
        const metric = document.getElementById('bubbleMetric').value;
        const value = data[metric] || 0;
        if (value <= 0) return null;
        
        let maxVal = 50000;
        if (metric === 'TUITION1' || metric === 'TUITION2') maxVal = 60000;
        if (metric === 'CSTOTLT') maxVal = 15000;
        
        const radius = Math.max(4, Math.min(32, (value / maxVal) * 32 + 4));
        const color = getColor(uni.CONTROL);
        
        const circle = L.circleMarker([lat, lng], {
            radius: radius,
            fillColor: color,
            fillOpacity: 0.35,
            color: color,
            weight: 2,
            opacity: 0.8
        });

        circle.bindPopup(createPopupContent(uni, data), { maxWidth: 300 });
        circle.universityData = uni;
        return circle;
    }

    function createPopupContent(uni, data) {
        const website = uni.WEBADDR ? (uni.WEBADDR.startsWith('http') ? uni.WEBADDR : 'https://' + uni.WEBADDR) : null;
        const tags = [];
        if (uni.HBCU === '1') tags.push('HBCU');
        if (uni.TRIBAL === '1') tags.push('Tribal');
        if (uni.LANDGRNT === '1') tags.push('Land Grant');
        if (uni.MEDICAL === '1') tags.push('Medical');
        
        return `
            <div class="popup-content">
                <div class="popup-header">
                    <h3>${uni.INSTNM}</h3>
                    <p>${uni.CITY}, ${uni.STABBR} ${uni.ZIP}</p>
                </div>
                <div class="popup-body">
                    <div class="popup-section">
                        <div class="popup-section-title">Key Metrics</div>
                        <div class="popup-stats">
                            <div class="popup-stat">
                                <div class="popup-stat-value">${formatNumber(data.ENRTOT)}</div>
                                <div class="popup-stat-label">Enrollment</div>
                            </div>
                            <div class="popup-stat">
                                <div class="popup-stat-value">${formatNumber(data.CSTOTLT)}</div>
                                <div class="popup-stat-label">Completions</div>
                            </div>
                            <div class="popup-stat">
                                <div class="popup-stat-value">${data.TUITION1 ? formatCurrency(data.TUITION1) : 'N/A'}</div>
                                <div class="popup-stat-label">In-State Tuition</div>
                            </div>
                            <div class="popup-stat">
                                <div class="popup-stat-value">${data.PCTENRW}%</div>
                                <div class="popup-stat-label">Female</div>
                            </div>
                        </div>
                    </div>
                    <div class="popup-section">
                        <div class="popup-section-title">Classification</div>
                        <div class="popup-tags">
                            <span class="popup-tag">${getControlType(uni.CONTROL)}</span>
                            <span class="popup-tag">${getDegreeName(uni.HDEGOFR1)}</span>
                            <span class="popup-tag">${getLocaleName(uni.LOCALE)}</span>
                            ${tags.map(t => `<span class="popup-tag">${t}</span>`).join('')}
                        </div>
                    </div>
                    ${website ? `<a href="${website}" target="_blank" class="popup-link">Visit Website â†’</a>` : ''}
                </div>
            </div>
        `;
    }

    // Update display
    function updateDisplay() {
        const filtered = universities.filter(matchesFilters);
        
        markers.clearLayers();
        bubbleLayer.clearLayers();
        
        if (bubbleMode) {
            map.removeLayer(markers);
            map.addLayer(bubbleLayer);
            filtered.forEach(uni => {
                const bubble = createBubbleMarker(uni);
                if (bubble) bubbleLayer.addLayer(bubble);
            });
        } else {
            map.removeLayer(bubbleLayer);
            map.addLayer(markers);
            filtered.forEach(uni => {
                const marker = createMarker(uni);
                if (marker) markers.addLayer(marker);
            });
        }
        
        updateResultsList(filtered.slice(0, 100));
        document.getElementById('visibleCount').textContent = filtered.length.toLocaleString();
        updateMarketSummary(filtered);
    }

    function updateResultsList(items) {
        const container = document.getElementById('resultsList');
        
        if (items.length === 0) {
            container.innerHTML = `<div class="no-results"><div class="no-results-icon">ðŸŽ“</div><p>No institutions match your filters</p></div>`;
            return;
        }

        container.innerHTML = items.map(uni => {
            const data = getEnrichedData(uni);
            return `
                <div class="result-item" data-lat="${uni.LATITUDE}" data-lng="${uni.LONGITUD}" data-name="${uni.INSTNM}">
                    <div class="result-name">${uni.INSTNM}</div>
                    <div class="result-location">${uni.CITY}, ${uni.STABBR}</div>
                    <div class="result-meta">
                        <span class="result-tag" style="color:${getColor(uni.CONTROL)}">${getControlType(uni.CONTROL)}</span>
                        <span class="result-enrollment">${formatNumber(data.ENRTOT)} students</span>
                    </div>
                </div>
            `;
        }).join('');

        container.querySelectorAll('.result-item').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.setView([lat, lng], 12);
                    const layer = bubbleMode ? bubbleLayer : markers;
                    layer.eachLayer(m => {
                        if (m.universityData && m.universityData.INSTNM === item.dataset.name) {
                            m.openPopup();
                        }
                    });
                }
            });
        });
    }

    function updateMarketSummary(filtered) {
        const totalEnrollment = filtered.reduce((sum, uni) => sum + (getEnrichedData(uni).ENRTOT || 0), 0);
        const publicCount = filtered.filter(u => u.CONTROL === '1').length;
        const privateCount = filtered.filter(u => u.CONTROL === '2' || u.CONTROL === '3').length;
        
        document.getElementById('summaryInstitutions').textContent = filtered.length.toLocaleString();
        document.getElementById('summaryEnrollment').textContent = formatNumber(totalEnrollment);
        document.getElementById('summaryPublic').textContent = publicCount.toLocaleString();
        document.getElementById('summaryPrivate').textContent = privateCount.toLocaleString();
    }

    function updateBubbleLegend() {
        const metric = document.getElementById('bubbleMetric').value;
        const titles = {
            'ENRTOT': 'Total Enrollment',
            'FTE': 'Full-Time Equivalent',
            'EFUG': 'Undergrad Enrollment',
            'EFGRAD': 'Graduate Enrollment',
            'CSTOTLT': 'Total Completions',
            'TUITION1': 'In-State Tuition',
            'TUITION2': 'Out-of-State Tuition'
        };
        
        document.getElementById('bubbleLegendTitle').textContent = titles[metric] || 'Size';
        
        if (metric === 'TUITION1' || metric === 'TUITION2') {
            document.getElementById('bubbleMin').textContent = '$10K';
            document.getElementById('bubbleMid').textContent = '$30K';
            document.getElementById('bubbleMax').textContent = '$60K+';
        } else if (metric === 'CSTOTLT') {
            document.getElementById('bubbleMin').textContent = '500';
            document.getElementById('bubbleMid').textContent = '5K';
            document.getElementById('bubbleMax').textContent = '15K+';
        } else {
            document.getElementById('bubbleMin').textContent = '1K';
            document.getElementById('bubbleMid').textContent = '25K';
            document.getElementById('bubbleMax').textContent = '50K+';
        }
    }

    // Export
    function exportFilteredData() {
        const filtered = universities.filter(matchesFilters);
        const headers = ['Name','City','State','ZIP','Type','Enrollment','Undergrad','Graduate','Completions','In-State Tuition','Out-of-State Tuition','Latitude','Longitude','Website'];
        
        const rows = filtered.map(uni => {
            const data = getEnrichedData(uni);
            return [
                `"${uni.INSTNM}"`,
                `"${uni.CITY}"`,
                uni.STABBR,
                uni.ZIP,
                getControlType(uni.CONTROL),
                data.ENRTOT,
                data.EFUG,
                data.EFGRAD,
                data.CSTOTLT,
                data.TUITION1,
                data.TUITION2,
                uni.LATITUDE,
                uni.LONGITUD,
                uni.WEBADDR || ''
            ].join(',');
        });
        
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `higher_ed_export_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Event listeners
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
        });
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        filters.search = e.target.value;
        updateDisplay();
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterType = btn.dataset.filter;
            const value = btn.dataset.value;
            btn.classList.toggle('active');
            
            if (btn.classList.contains('active')) {
                filters[filterType].push(value);
            } else {
                filters[filterType] = filters[filterType].filter(v => v !== value);
            }
            updateDisplay();
        });
    });

    document.querySelectorAll('.filter-clear').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterType = btn.dataset.filter;
            filters[filterType] = [];
            document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(fb => {
                fb.classList.remove('active');
            });
            if (filterType === 'state') {
                document.getElementById('stateFilter').value = '';
                filters.state = '';
            }
            updateDisplay();
        });
    });

    document.getElementById('stateFilter').addEventListener('change', (e) => {
        filters.state = e.target.value;
        updateDisplay();
    });

    document.getElementById('enrollmentSlider').addEventListener('input', (e) => {
        filters.minEnrollment = parseInt(e.target.value);
        document.getElementById('enrollmentValue').textContent = formatNumber(filters.minEnrollment);
        updateDisplay();
    });

    document.getElementById('completionsSlider').addEventListener('input', (e) => {
        filters.minCompletions = parseInt(e.target.value);
        document.getElementById('completionsValue').textContent = formatNumber(filters.minCompletions);
        updateDisplay();
    });

    document.getElementById('bubbleToggle').addEventListener('click', () => {
        const toggle = document.getElementById('bubbleToggle');
        const metricSelect = document.getElementById('bubbleMetric');
        const bubbleLegend = document.getElementById('bubbleLegend');
        
        toggle.classList.toggle('active');
        bubbleMode = toggle.classList.contains('active');
        metricSelect.disabled = !bubbleMode;
        bubbleLegend.style.display = bubbleMode ? 'block' : 'none';
        
        updateDisplay();
    });

    document.getElementById('bubbleMetric').addEventListener('change', () => {
        updateBubbleLegend();
        updateDisplay();
    });

    document.getElementById('exportBtn').addEventListener('click', exportFilteredData);

    // Initialize
    async function init() {
        try {
            const [hdRes, efRes, cRes, costRes] = await Promise.all([
                fetch('universities.csv'),
                fetch('enrollment.csv'),
                fetch('completions.csv'),
                fetch('costs.csv')
            ]);
            
            const [hdText, efText, cText, costText] = await Promise.all([
                hdRes.text(), efRes.text(), cRes.text(), costRes.text()
            ]);
            
            universities = parseCSV(hdText);
            parseCSV(efText).forEach(row => { enrollmentData[row.UNITID] = row; });
            parseCSV(cText).forEach(row => { completionsData[row.UNITID] = row; });
            parseCSV(costText).forEach(row => { costData[row.UNITID] = row; });
            
            // Filter valid coordinates
            universities = universities.filter(uni => {
                const lat = parseFloat(uni.LATITUDE);
                const lng = parseFloat(uni.LONGITUD);
                return !isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0;
            });
            
            // Populate state dropdown
            const states = [...new Set(universities.map(u => u.STABBR))].sort();
            const stateSelect = document.getElementById('stateFilter');
            states.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                stateSelect.appendChild(opt);
            });
            
            // Calculate totals
            const totalEnrollment = universities.reduce((sum, uni) => sum + (getEnrichedData(uni).ENRTOT || 0), 0);
            
            document.getElementById('totalCount').textContent = universities.length.toLocaleString();
            document.getElementById('totalEnrollment').textContent = formatNumber(totalEnrollment);
            document.getElementById('stateCount').textContent = states.length;
            
            map.addLayer(markers);
            updateDisplay();
            
            document.getElementById('loading').classList.add('hidden');
            
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loading').innerHTML = `
                <div style="color:#fff;text-align:center;padding:2rem">
                    <p style="font-size:1.2rem;margin-bottom:.5rem">Error Loading Data</p>
                    <p style="font-size:.85rem;opacity:.7">${error.message}</p>
                </div>
            `;
        }
    }

    init();
    </script>
</body>
</html>
