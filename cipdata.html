<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Higher Ed Market Intelligence | IPEDS 2024</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2236;
            --bg-card-hover: #1f2a42;
            --accent-gold: #f59e0b;
            --accent-gold-dim: rgba(245, 158, 11, 0.15);
            --accent-teal: #14b8a6;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-rose: #f43f5e;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-subtle: rgba(148, 163, 184, 0.1);
            --border-active: rgba(245, 158, 11, 0.4);
            --shadow-glow: 0 0 60px rgba(245, 158, 11, 0.08);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 2rem;
            letter-spacing: -0.02em;
        }

        .loading-bar {
            width: 200px;
            height: 3px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
        }

        .loading-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-teal));
            width: 0%;
            transition: width 0.3s;
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            padding: 1.25rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(12px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-teal));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Layout */
        .app-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            min-height: 100vh;
            padding-top: 72px;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            height: calc(100vh - 72px);
            overflow-y: auto;
            padding: 1.5rem;
            position: sticky;
            top: 72px;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-section-title button {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 0.65rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .filter-section-title button:hover {
            opacity: 1;
        }

        /* Radius Filter Section - Special Styling */
        .radius-filter-section {
            background: linear-gradient(135deg, var(--accent-gold-dim), transparent);
            border: 1px solid var(--border-active);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .radius-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .radius-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 0.875rem;
        }

        .radius-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .radius-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .radius-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .radius-input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-family: inherit;
        }

        .radius-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .radius-input::placeholder {
            color: var(--text-muted);
        }

        .radius-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .radius-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radius-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .radius-btn.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        .radius-actions {
            display: flex;
            gap: 0.5rem;
        }

        .radius-set-btn {
            flex: 1;
            padding: 0.6rem;
            background: var(--accent-gold);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--bg-primary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radius-set-btn:hover {
            filter: brightness(1.1);
        }

        .radius-set-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .radius-clear-btn {
            padding: 0.6rem 1rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radius-clear-btn:hover {
            border-color: var(--accent-rose);
            color: var(--accent-rose);
        }

        .radius-status {
            margin-top: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: none;
        }

        .radius-status.active {
            display: block;
        }

        .radius-status .location-name {
            color: var(--accent-gold);
            font-weight: 500;
        }

        .radius-status .count {
            color: var(--accent-teal);
            font-weight: 600;
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-chip {
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: var(--accent-gold);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: var(--accent-gold-dim);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Select Dropdown */
        .filter-select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        
        /* Multi-Select Program Filter */
        .program-filter-section {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), transparent);
            border: 1px solid rgba(20, 184, 166, 0.3);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .program-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .program-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 0.875rem;
        }

        .program-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .program-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .multiselect-container {
            position: relative;
        }

        .multiselect-input-wrapper {
            position: relative;
        }

        .multiselect-search {
            width: 100%;
            padding: 0.6rem 2.5rem 0.6rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-family: inherit;
        }

        .multiselect-search:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .multiselect-search::placeholder {
            color: var(--text-muted);
        }

        .multiselect-toggle {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .multiselect-toggle.open {
            transform: translateY(-50%) rotate(180deg);
        }

        .multiselect-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            max-height: 280px;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            z-index: 100;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .multiselect-dropdown.open {
            display: block;
        }

        .multiselect-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .multiselect-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }

        .multiselect-dropdown::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border-subtle);
        }

        .multiselect-option:last-child {
            border-bottom: none;
        }

        .multiselect-option:hover {
            background: var(--bg-card-hover);
        }

        .multiselect-option.selected {
            background: rgba(20, 184, 166, 0.15);
        }

        .multiselect-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .multiselect-option.selected .multiselect-checkbox {
            background: var(--accent-teal);
            border-color: var(--accent-teal);
        }

        .multiselect-checkbox svg {
            width: 10px;
            height: 10px;
            stroke: var(--bg-primary);
            stroke-width: 3;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .multiselect-option.selected .multiselect-checkbox svg {
            opacity: 1;
        }

        .multiselect-option-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex: 1;
            line-height: 1.3;
        }

        .multiselect-option.selected .multiselect-option-text {
            color: var(--text-primary);
        }

        .multiselect-option-code {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: monospace;
            background: var(--bg-primary);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }

        .multiselect-no-results {
            padding: 1rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .selected-programs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }

        .selected-tag {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.5rem;
            background: var(--accent-teal);
            border-radius: 100px;
            font-size: 0.7rem;
            color: var(--bg-primary);
            font-weight: 500;
        }

        .selected-tag-remove {
            background: none;
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.15s;
        }

        .selected-tag-remove:hover {
            opacity: 1;
        }

        .program-clear-btn {
            margin-top: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .program-clear-btn:hover {
            border-color: var(--accent-rose);
            color: var(--accent-rose);
        }

        .program-count {
            font-size: 0.7rem;
            color: var(--accent-teal);
            margin-top: 0.5rem;
        }

        .popup-programs {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .popup-programs-title {
            color: var(--accent-teal);
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

/* Range Slider */
        .range-container {
            padding: 0.5rem 0;
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .range-value {
            color: var(--accent-gold);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-gold);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Results Counter */
        .results-counter {
            padding: 1rem;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            text-align: center;
        }

        .results-counter strong {
            color: var(--accent-gold);
            font-size: 1.5rem;
        }

        .results-counter span {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .export-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-teal));
            border: none;
            border-radius: var(--radius-sm);
            color: var(--bg-primary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
        }

        /* Map Controls */
        .map-controls {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .map-control-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bubble-select {
            padding: 0.5rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.8rem;
            font-family: inherit;
            min-width: 200px;
        }

        .bubble-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .legend {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.public { background: var(--accent-blue); }
        .legend-dot.private-np { background: var(--accent-teal); }
        .legend-dot.private-fp { background: var(--accent-purple); }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            min-height: 500px;
        }

        #map {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
        }

        /* Leaflet customization */
        .leaflet-container {
            background: var(--bg-primary);
            font-family: 'DM Sans', sans-serif;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .leaflet-popup-content {
            margin: 1rem;
            min-width: 200px;
        }

        .popup-title {
            font-family: 'Instrument Serif', serif;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .popup-location {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .popup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .popup-stat {
            background: var(--bg-primary);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
        }

        .popup-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .popup-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .popup-distance {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            font-size: 0.8rem;
            color: var(--accent-teal);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Summary Panel */
        .summary-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
            padding: 1.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .summary-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-card-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Pin Marker */
        .pin-marker {
            position: relative;
        }

        .pin-marker::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Institution marker styles */
        .institution-marker {
            border-radius: 50%;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
            cursor: pointer;
        }

        .institution-marker:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Radius circle styling */
        .radius-circle {
            fill: rgba(245, 158, 11, 0.1);
            stroke: var(--accent-gold);
            stroke-width: 2;
            stroke-dasharray: 8 4;
        }

        /* Click instructions */
        .click-instruction {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            z-index: 1000;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .click-instruction.hidden {
            opacity: 0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                width: 320px;
                height: calc(100vh - 72px);
                z-index: 900;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .header-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">Higher Ed Intelligence</div>
        <div class="loading-bar">
            <div class="loading-bar-fill" id="loadingBar"></div>
        </div>
        <div class="loading-text" id="loadingText">Initializing...</div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üéì</div>
                <span>Higher Ed Market Intelligence</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="headerInstitutions">‚Äî</div>
                    <div class="header-stat-label">Institutions</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerEnrollment">‚Äî</div>
                    <div class="header-stat-label">Total Enrollment</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerStates">‚Äî</div>
                    <div class="header-stat-label">States</div>
                </div>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Radius Filter - Featured -->
            <div class="radius-filter-section">
                <div class="radius-header">
                    <div class="radius-icon">üìç</div>
                    <div>
                        <div class="radius-title">Geographic Radius Filter</div>
                        <div class="radius-subtitle">Click map or enter location</div>
                    </div>
                </div>
                
                <div class="radius-input-group">
                    <input type="text" class="radius-input" id="locationSearch" placeholder="City, State or ZIP...">
                </div>
                
                <div class="radius-buttons">
                    <button class="radius-btn" data-miles="50">50 mi</button>
                    <button class="radius-btn active" data-miles="100">100 mi</button>
                    <button class="radius-btn" data-miles="200">200 mi</button>
                </div>
                
                <div class="radius-actions">
                    <button class="radius-set-btn" id="setRadiusBtn">Set Location</button>
                    <button class="radius-clear-btn" id="clearRadiusBtn">Clear</button>
                </div>
                
                <div class="radius-status" id="radiusStatus">
                    <span class="location-name" id="radiusLocationName"></span> ‚Ä¢ 
                    <span class="count" id="radiusCount"></span> institutions within radius
                </div>
            </div>

            
            <!-- Program Filter - Featured -->
            <div class="program-filter-section">
                <div class="program-header">
                    <div class="program-icon">üìö</div>
                    <div>
                        <div class="program-title">Academic Programs (CIP)</div>
                        <div class="program-subtitle">Search and select multiple programs</div>
                    </div>
                </div>
                
                <div class="multiselect-container" id="programMultiselect">
                    <div class="multiselect-input-wrapper">
                        <input type="text" class="multiselect-search" id="programSearch" placeholder="Type to search programs...">
                        <button class="multiselect-toggle" id="programToggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>
                    </div>
                    <div class="multiselect-dropdown" id="programDropdown"></div>
                </div>
                
                <div class="selected-programs" id="selectedPrograms"></div>
                <div class="program-count" id="programCount"></div>
                <button class="program-clear-btn" id="clearProgramsBtn" style="display: none;">Clear All Programs</button>
            </div>

            <!-- Institution Type -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Institution Type
                    <button onclick="clearFilter('control')">Clear</button>
                </div>
                <div class="filter-chips" id="controlFilters">
                    <button class="filter-chip" data-filter="control" data-value="1">Public</button>
                    <button class="filter-chip" data-filter="control" data-value="2">Private Non-Profit</button>
                    <button class="filter-chip" data-filter="control" data-value="3">Private For-Profit</button>
                </div>
            </div>

            <!-- Highest Degree -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Highest Degree Offered
                    <button onclick="clearFilter('degree')">Clear</button>
                </div>
                <div class="filter-chips" id="degreeFilters">
                    <button class="filter-chip" data-filter="degree" data-value="9">Doctoral</button>
                    <button class="filter-chip" data-filter="degree" data-value="7">Master's</button>
                    <button class="filter-chip" data-filter="degree" data-value="5">Bachelor's</button>
                    <button class="filter-chip" data-filter="degree" data-value="3">Associate's</button>
                    <button class="filter-chip" data-filter="degree" data-value="1">Certificate</button>
                </div>
            </div>

            <!-- Locale -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Locale Setting
                    <button onclick="clearFilter('locale')">Clear</button>
                </div>
                <div class="filter-chips" id="localeFilters">
                    <button class="filter-chip" data-filter="locale" data-value="city">City</button>
                    <button class="filter-chip" data-filter="locale" data-value="suburb">Suburb</button>
                    <button class="filter-chip" data-filter="locale" data-value="town">Town</button>
                    <button class="filter-chip" data-filter="locale" data-value="rural">Rural</button>
                </div>
            </div>

            <!-- Institution Size -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Institution Size
                    <button onclick="clearFilter('size')">Clear</button>
                </div>
                <div class="filter-chips" id="sizeFilters">
                    <button class="filter-chip" data-filter="size" data-value="1">Under 1K</button>
                    <button class="filter-chip" data-filter="size" data-value="2">1K-5K</button>
                    <button class="filter-chip" data-filter="size" data-value="3">5K-10K</button>
                    <button class="filter-chip" data-filter="size" data-value="4">10K-20K</button>
                    <button class="filter-chip" data-filter="size" data-value="5">20K+</button>
                </div>
            </div>

            <!-- Special Designations -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Special Designations
                    <button onclick="clearFilter('special')">Clear</button>
                </div>
                <div class="filter-chips" id="specialFilters">
                    <button class="filter-chip" data-filter="special" data-value="hbcu">HBCU</button>
                    <button class="filter-chip" data-filter="special" data-value="tribal">Tribal</button>
                    <button class="filter-chip" data-filter="special" data-value="landgrant">Land Grant</button>
                    <button class="filter-chip" data-filter="special" data-value="medical">Medical</button>
                </div>
            </div>

            <!-- Carnegie Classification -->
            <div class="filter-section">
                <div class="filter-section-title">
                    Carnegie Classification
                    <button onclick="clearFilter('carnegie')">Clear</button>
                </div>
                <div class="filter-chips" id="carnegieFilters">
                    <button class="filter-chip" data-filter="carnegie" data-value="15">R1 Research</button>
                    <button class="filter-chip" data-filter="carnegie" data-value="16">R2 Research</button>
                    <button class="filter-chip" data-filter="carnegie" data-value="master">Master's</button>
                    <button class="filter-chip" data-filter="carnegie" data-value="bacc">Baccalaureate</button>
                </div>
            </div>

            <!-- State Filter -->
            <div class="filter-section">
                <div class="filter-section-title">
                    State / Region
                    <button onclick="clearFilter('state')">Clear</button>
                </div>
                <select class="filter-select" id="stateFilter">
                    <option value="">All States & Territories</option>
                </select>
            </div>

            <!-- Min Enrollment -->
            <div class="filter-section">
                <div class="filter-section-title">Minimum Enrollment</div>
                <div class="range-container">
                    <div class="range-labels">
                        <span>0</span>
                        <span class="range-value" id="enrollmentValue">0</span>
                    </div>
                    <input type="range" id="enrollmentRange" min="0" max="50000" step="1000" value="0">
                </div>
            </div>

            <!-- Min Completions -->
            <div class="filter-section">
                <div class="filter-section-title">Minimum Completions</div>
                <div class="range-container">
                    <div class="range-labels">
                        <span>0</span>
                        <span class="range-value" id="completionsValue">0</span>
                    </div>
                    <input type="range" id="completionsRange" min="0" max="10000" step="100" value="0">
                </div>
            </div>

            <!-- Results -->
            <div class="results-counter">
                <strong id="resultsCount">0</strong>
                <span> institutions</span>
            </div>
            
            <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Map Controls -->
            <div class="map-controls">
                <span class="map-control-label">Bubble Size:</span>
                <select class="bubble-select" id="bubbleMetric">
                    <option value="enrollment">Total Enrollment</option>
                    <option value="fte">Full-Time Equivalent (FTE)</option>
                    <option value="undergraduate">Undergraduate Enrollment</option>
                    <option value="graduate">Graduate Enrollment</option>
                    <option value="completions">Total Completions/Graduates</option>
                    <option value="tuition_in">In-State Tuition</option>
                    <option value="tuition_out">Out-of-State Tuition</option>
                </select>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot public"></div>
                        <span>Public</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot private-np"></div>
                        <span>Private Non-Profit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot private-fp"></div>
                        <span>Private For-Profit</span>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                <div class="click-instruction" id="clickInstruction">
                    üí° Click anywhere on the map to set a radius filter location
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="summary-panel">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryInstitutions">‚Äî</div>
                        <div class="summary-card-label">Institutions</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryStudents">‚Äî</div>
                        <div class="summary-card-label">Total Students</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryPublic">‚Äî</div>
                        <div class="summary-card-label">Public</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryPrivate">‚Äî</div>
                        <div class="summary-card-label">Private</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryAvgEnrollment">‚Äî</div>
                        <div class="summary-card-label">Avg Enrollment</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-value" id="summaryAvgTuition">‚Äî</div>
                        <div class="summary-card-label">Avg In-State Tuition</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Global state
        let allData = [];
        let filteredData = [];
        let map;
        let markersLayer;
        let radiusCircle = null;
        let pinMarker = null;
        let radiusCenter = null;
        let selectedRadius = 100; // Default 100 miles

        // Filter state
        const filters = {
            control: [],
            degree: [],
            locale: [],
            size: [],
            special: [],
            carnegie: [],
            state: '',
            minEnrollment: 0,
            minCompletions: 0,
            programs: []
        };

        // State name mapping
        const stateNames = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
            'DC': 'District of Columbia', 'PR': 'Puerto Rico', 'VI': 'Virgin Islands', 'GU': 'Guam',
            'AS': 'American Samoa', 'MP': 'Northern Mariana Islands', 'FM': 'Micronesia', 'MH': 'Marshall Islands', 'PW': 'Palau'
        };
        // CIP Code Categories (2-digit level with common sub-categories)
        const cipCategories = {
            1: { name: "Agriculture & Related Sciences", keywords: ["agriculture", "farming", "agribusiness", "horticulture", "animal science", "veterinary"] },
            3: { name: "Natural Resources & Conservation", keywords: ["natural resources", "conservation", "environmental", "forestry", "wildlife"] },
            4: { name: "Architecture & Related Services", keywords: ["architecture", "urban planning", "interior design", "landscape"] },
            5: { name: "Area, Ethnic & Cultural Studies", keywords: ["area studies", "ethnic", "cultural", "gender", "african", "asian", "latin"] },
            9: { name: "Communication & Journalism", keywords: ["communication", "journalism", "media", "broadcasting", "public relations"] },
            10: { name: "Communications Technologies", keywords: ["communications tech", "audio", "video", "film", "recording"] },
            11: { name: "Computer & Information Sciences", keywords: ["computer science", "information technology", "cybersecurity", "data science", "programming", "software"] },
            12: { name: "Culinary & Personal Services", keywords: ["culinary", "cosmetology", "funeral", "entertainment"] },
            13: { name: "Education", keywords: ["education", "teaching", "curriculum", "elementary", "secondary", "special education"] },
            14: { name: "Engineering", keywords: ["engineering", "mechanical", "electrical", "civil", "chemical", "aerospace", "biomedical"] },
            15: { name: "Engineering Technologies", keywords: ["engineering tech", "drafting", "hvac", "manufacturing tech"] },
            16: { name: "Foreign Languages & Linguistics", keywords: ["language", "linguistics", "spanish", "french", "german", "chinese", "translation"] },
            19: { name: "Family & Consumer Sciences", keywords: ["family", "consumer", "nutrition", "food science", "textiles"] },
            22: { name: "Legal Professions & Studies", keywords: ["law", "legal", "paralegal", "pre-law", "jurisprudence"] },
            23: { name: "English Language & Literature", keywords: ["english", "literature", "writing", "creative writing", "composition"] },
            24: { name: "Liberal Arts & Humanities", keywords: ["liberal arts", "humanities", "general studies", "interdisciplinary"] },
            25: { name: "Library Science", keywords: ["library", "information science", "archival"] },
            26: { name: "Biological & Biomedical Sciences", keywords: ["biology", "biomedical", "biochemistry", "microbiology", "genetics", "neuroscience"] },
            27: { name: "Mathematics & Statistics", keywords: ["mathematics", "statistics", "actuarial", "applied math"] },
            30: { name: "Multi/Interdisciplinary Studies", keywords: ["interdisciplinary", "gerontology", "sustainability", "cognitive science"] },
            31: { name: "Parks, Recreation & Fitness", keywords: ["parks", "recreation", "fitness", "sports management", "kinesiology", "exercise"] },
            38: { name: "Philosophy & Religious Studies", keywords: ["philosophy", "religious", "ethics", "theology"] },
            39: { name: "Theology & Religious Vocations", keywords: ["theology", "ministry", "divinity", "pastoral", "religious"] },
            40: { name: "Physical Sciences", keywords: ["physics", "chemistry", "astronomy", "geology", "earth science", "atmospheric"] },
            41: { name: "Science Technologies", keywords: ["science tech", "laboratory", "nuclear"] },
            42: { name: "Psychology", keywords: ["psychology", "clinical psychology", "counseling psychology", "behavioral"] },
            43: { name: "Homeland Security & Law Enforcement", keywords: ["criminal justice", "homeland security", "law enforcement", "firefighting", "forensics", "corrections"] },
            44: { name: "Public Administration & Social Service", keywords: ["public administration", "social work", "public policy", "nonprofit"] },
            45: { name: "Social Sciences", keywords: ["social science", "sociology", "political science", "economics", "anthropology", "geography", "international relations"] },
            46: { name: "Construction Trades", keywords: ["construction", "carpentry", "plumbing", "electrical trade", "masonry"] },
            47: { name: "Mechanic & Repair Technologies", keywords: ["mechanic", "automotive", "aircraft", "diesel", "repair"] },
            48: { name: "Precision Production", keywords: ["precision", "machining", "welding", "woodworking"] },
            49: { name: "Transportation & Materials Moving", keywords: ["transportation", "aviation", "trucking", "logistics"] },
            50: { name: "Visual & Performing Arts", keywords: ["art", "music", "theater", "dance", "film", "design", "photography", "graphic design"] },
            51: { name: "Health Professions & Related", keywords: ["health", "nursing", "medical", "pharmacy", "dental", "physical therapy", "occupational therapy", "healthcare", "public health"] },
            52: { name: "Business, Management & Marketing", keywords: ["business", "management", "marketing", "accounting", "finance", "mba", "entrepreneurship", "human resources"] },
            54: { name: "History", keywords: ["history", "historical"] }
        };

        let institutionCipMap = new Map();
        let selectedPrograms = [];



        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            updateLoadingStatus('Initializing map...', 10);
            initMap();
            
            updateLoadingStatus('Loading institution data...', 30);
            await loadData();
            
            updateLoadingStatus('Setting up filters...', 80);
            setupFilters();
            setupRadiusControls();
            setupProgramFilter();
            
            updateLoadingStatus('Rendering visualization...', 90);
            applyFilters();
            
            updateLoadingStatus('Complete!', 100);
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 500);
        }

        function updateLoadingStatus(text, percent) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingBar').style.width = percent + '%';
        }

        function initMap() {
            map = L.map('map', {
                center: [39.8283, -98.5795],
                zoom: 4,
                minZoom: 3,
                maxZoom: 18
            });

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 19
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);

            // Map click handler for radius
            map.on('click', onMapClick);
        }

        function onMapClick(e) {
            setRadiusLocation(e.latlng.lat, e.latlng.lng, `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
        }

        async function loadData() {
            try {
                // Load all CSV files
                const [hdData, drvefData, costData, completionsData] = await Promise.all([
                    loadCSV('hd2024.csv'),
                    loadCSV('drvef2024.csv'),
                    loadCSV('cost1_2024.csv'),
                    loadCSV('c2024_b.csv')
                ]);

                // Create lookup maps
                // Build institution to CIP code mapping
                costData.forEach(row => {
                    const unitid = row.UNITID;
                    const cips = [];
                    ['CIPCODE1', 'CIPCODE2', 'CIPCODE3', 'CIPCODE4', 'CIPCODE5', 'CIPCODE6'].forEach(col => {
                        if (row[col] && parseFloat(row[col]) > 0) {
                            cips.push(parseFloat(row[col]));
                        }
                    });
                    if (cips.length > 0) {
                        institutionCipMap.set(unitid, cips);
                    }
                });

                const enrollmentMap = new Map(drvefData.map(d => [d.UNITID, d]));
                const costMap = new Map(costData.map(d => [d.UNITID, d]));
                const completionsMap = new Map(completionsData.map(d => [d.UNITID, d]));

                // Merge data
                allData = hdData
                    .filter(d => d.LATITUDE && d.LONGITUD && d.CYACTIVE === '1')
                    .map(d => {
                        const enrollment = enrollmentMap.get(d.UNITID) || {};
                        const cost = costMap.get(d.UNITID) || {};
                        const completions = completionsMap.get(d.UNITID) || {};

                        return {
                            unitid: d.UNITID,
                            name: d.INSTNM,
                            city: d.CITY,
                            state: d.STABBR,
                            lat: parseFloat(d.LATITUDE),
                            lng: parseFloat(d.LONGITUD),
                            control: parseInt(d.CONTROL) || 0,
                            hloffer: parseInt(d.HLOFFER) || 0,
                            locale: parseInt(d.LOCALE) || 0,
                            instsize: parseInt(d.INSTSIZE) || 0,
                            hbcu: parseInt(d.HBCU) || 0,
                            tribal: parseInt(d.TRIBAL) || 0,
                            landgrant: parseInt(d.LANDGRNT) || 0,
                            medical: parseInt(d.MEDICAL) || 0,
                            c21basic: parseInt(d.C21BASIC) || 0,
                            enrollment: parseInt(enrollment.ENRTOT) || 0,
                            fte: parseInt(enrollment.FTE) || 0,
                            undergraduate: parseInt(enrollment.EFUG) || 0,
                            graduate: parseInt(enrollment.EFGRAD) || 0,
                            tuition_in: parseFloat(cost.TUITION1) || 0,
                            tuition_out: parseFloat(cost.TUITION2) || 0,
                            completions: parseInt(completions.CSTOTLT) || 0,
                            cipCodes: institutionCipMap.get(d.UNITID) || []
                        };
                    })
                    .filter(d => !isNaN(d.lat) && !isNaN(d.lng));

                // Populate state dropdown
                const states = [...new Set(allData.map(d => d.state))].sort();
                const stateSelect = document.getElementById('stateFilter');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = stateNames[state] || state;
                    stateSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function loadCSV(filename) {
            return new Promise((resolve, reject) => {
                Papa.parse(filename, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: results => resolve(results.data),
                    error: reject
                });
            });
        }

        
        function setupProgramFilter() {
            const searchInput = document.getElementById('programSearch');
            const dropdown = document.getElementById('programDropdown');
            const toggle = document.getElementById('programToggle');
            const clearBtn = document.getElementById('clearProgramsBtn');

            renderProgramOptions('');

            searchInput.addEventListener('input', (e) => {
                renderProgramOptions(e.target.value);
                dropdown.classList.add('open');
                toggle.classList.add('open');
            });

            searchInput.addEventListener('focus', () => {
                dropdown.classList.add('open');
                toggle.classList.add('open');
            });

            toggle.addEventListener('click', () => {
                dropdown.classList.toggle('open');
                toggle.classList.toggle('open');
                if (dropdown.classList.contains('open')) {
                    searchInput.focus();
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#programMultiselect')) {
                    dropdown.classList.remove('open');
                    toggle.classList.remove('open');
                }
            });

            clearBtn.addEventListener('click', () => {
                selectedPrograms = [];
                filters.programs = [];
                updateSelectedProgramsUI();
                renderProgramOptions(searchInput.value);
                applyFilters();
            });
        }

        function renderProgramOptions(searchTerm) {
            const dropdown = document.getElementById('programDropdown');
            const term = searchTerm.toLowerCase().trim();
            
            let html = '';
            let matchCount = 0;

            Object.entries(cipCategories).forEach(([code, data]) => {
                const codeNum = parseInt(code);
                const matchesCode = code.includes(term);
                const matchesName = data.name.toLowerCase().includes(term);
                const matchesKeyword = data.keywords.some(kw => kw.includes(term));
                
                if (term === '' || matchesCode || matchesName || matchesKeyword) {
                    matchCount++;
                    const isSelected = selectedPrograms.includes(codeNum);
                    
                    html += `
                        <div class="multiselect-option ${isSelected ? 'selected' : ''}" 
                             data-code="${codeNum}" 
                             onclick="toggleProgram(${codeNum})">
                            <div class="multiselect-checkbox">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <span class="multiselect-option-text">${data.name}</span>
                            <span class="multiselect-option-code">${code.padStart(2, '0')}</span>
                        </div>
                    `;
                }
            });

            if (matchCount === 0) {
                html = '<div class="multiselect-no-results">No matching programs found</div>';
            }

            dropdown.innerHTML = html;
        }

        function toggleProgram(code) {
            const index = selectedPrograms.indexOf(code);
            
            if (index === -1) {
                selectedPrograms.push(code);
            } else {
                selectedPrograms.splice(index, 1);
            }
            
            filters.programs = [...selectedPrograms];
            updateSelectedProgramsUI();
            renderProgramOptions(document.getElementById('programSearch').value);
            applyFilters();
        }

        function updateSelectedProgramsUI() {
            const container = document.getElementById('selectedPrograms');
            const clearBtn = document.getElementById('clearProgramsBtn');
            const countEl = document.getElementById('programCount');
            
            if (selectedPrograms.length === 0) {
                container.innerHTML = '';
                clearBtn.style.display = 'none';
                countEl.textContent = '';
                return;
            }

            clearBtn.style.display = 'block';
            
            const tags = selectedPrograms.map(code => {
                const data = cipCategories[code];
                const shortName = data.name.length > 20 ? data.name.substring(0, 20) + '...' : data.name;
                return `
                    <span class="selected-tag">
                        ${shortName}
                        <button class="selected-tag-remove" onclick="removeProgram(${code}); event.stopPropagation();">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </span>
                `;
            }).join('');

            container.innerHTML = tags;
            
            const matchingInstitutions = allData.filter(d => {
                return selectedPrograms.some(selectedCip => {
                    return d.cipCodes.some(instCip => Math.floor(instCip) === selectedCip);
                });
            }).length;
            
            countEl.textContent = `${matchingInstitutions} institutions offer selected programs`;
        }

        function removeProgram(code) {
            const index = selectedPrograms.indexOf(code);
            if (index !== -1) {
                selectedPrograms.splice(index, 1);
                filters.programs = [...selectedPrograms];
                updateSelectedProgramsUI();
                renderProgramOptions(document.getElementById('programSearch').value);
                applyFilters();
            }
        }

        function setupFilters() {
            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    updateFilterFromChips();
                });
            });

            // State filter
            document.getElementById('stateFilter').addEventListener('change', e => {
                filters.state = e.target.value;
                applyFilters();
            });

            // Range sliders
            document.getElementById('enrollmentRange').addEventListener('input', e => {
                filters.minEnrollment = parseInt(e.target.value);
                document.getElementById('enrollmentValue').textContent = formatNumber(filters.minEnrollment);
                applyFilters();
            });

            document.getElementById('completionsRange').addEventListener('input', e => {
                filters.minCompletions = parseInt(e.target.value);
                document.getElementById('completionsValue').textContent = formatNumber(filters.minCompletions);
                applyFilters();
            });

            // Bubble metric
            document.getElementById('bubbleMetric').addEventListener('change', () => {
                renderMarkers();
            });
        }

        function setupRadiusControls() {
            // Radius buttons
            document.querySelectorAll('.radius-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedRadius = parseInt(btn.dataset.miles);
                    if (radiusCenter) {
                        updateRadiusCircle();
                        applyFilters();
                    }
                });
            });

            // Set radius button
            document.getElementById('setRadiusBtn').addEventListener('click', async () => {
                const query = document.getElementById('locationSearch').value.trim();
                if (query) {
                    await geocodeAndSetRadius(query);
                }
            });

            // Clear radius button
            document.getElementById('clearRadiusBtn').addEventListener('click', clearRadius);

            // Enter key on location input
            document.getElementById('locationSearch').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        await geocodeAndSetRadius(query);
                    }
                }
            });
        }

        async function geocodeAndSetRadius(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=1`);
                const results = await response.json();
                
                if (results.length > 0) {
                    const { lat, lon, display_name } = results[0];
                    const shortName = display_name.split(',').slice(0, 2).join(',');
                    setRadiusLocation(parseFloat(lat), parseFloat(lon), shortName);
                } else {
                    alert('Location not found. Please try a different search.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error searching for location. Please try again.');
            }
        }

        function setRadiusLocation(lat, lng, locationName) {
            radiusCenter = { lat, lng, name: locationName };
            
            // Remove existing pin marker
            if (pinMarker) {
                map.removeLayer(pinMarker);
            }

            // Add pin marker
            const pinIcon = L.divIcon({
                className: 'pin-marker-icon',
                html: `<div style="
                    width: 24px;
                    height: 24px;
                    background: #f59e0b;
                    border: 3px solid #fff;
                    border-radius: 50%;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            pinMarker = L.marker([lat, lng], { icon: pinIcon }).addTo(map);
            pinMarker.bindPopup(`<strong>üìç Filter Center</strong><br>${locationName}<br>Radius: ${selectedRadius} miles`);

            updateRadiusCircle();
            applyFilters();

            // Update UI
            document.getElementById('locationSearch').value = locationName;
            document.getElementById('clickInstruction').classList.add('hidden');
            
            // Center map on radius
            map.setView([lat, lng], getZoomForRadius(selectedRadius));
        }

        function updateRadiusCircle() {
            if (!radiusCenter) return;

            // Remove existing circle
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
            }

            // Convert miles to meters
            const radiusMeters = selectedRadius * 1609.34;

            // Add circle
            radiusCircle = L.circle([radiusCenter.lat, radiusCenter.lng], {
                radius: radiusMeters,
                color: '#f59e0b',
                fillColor: '#f59e0b',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '8, 4'
            }).addTo(map);

            // Update pin popup
            if (pinMarker) {
                pinMarker.setPopupContent(`<strong>üìç Filter Center</strong><br>${radiusCenter.name}<br>Radius: ${selectedRadius} miles`);
            }
        }

        function getZoomForRadius(miles) {
            if (miles <= 50) return 8;
            if (miles <= 100) return 7;
            return 6;
        }

        function clearRadius() {
            radiusCenter = null;
            
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
                radiusCircle = null;
            }
            
            if (pinMarker) {
                map.removeLayer(pinMarker);
                pinMarker = null;
            }

            document.getElementById('locationSearch').value = '';
            document.getElementById('radiusStatus').classList.remove('active');
            document.getElementById('clickInstruction').classList.remove('hidden');
            
            applyFilters();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula
            const R = 3959; // Earth's radius in miles
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toRad(deg) {
            return deg * (Math.PI / 180);
        }

        function updateFilterFromChips() {
            filters.control = [...document.querySelectorAll('.filter-chip[data-filter="control"].active')]
                .map(c => c.dataset.value);
            filters.degree = [...document.querySelectorAll('.filter-chip[data-filter="degree"].active')]
                .map(c => c.dataset.value);
            filters.locale = [...document.querySelectorAll('.filter-chip[data-filter="locale"].active')]
                .map(c => c.dataset.value);
            filters.size = [...document.querySelectorAll('.filter-chip[data-filter="size"].active')]
                .map(c => c.dataset.value);
            filters.special = [...document.querySelectorAll('.filter-chip[data-filter="special"].active')]
                .map(c => c.dataset.value);
            filters.carnegie = [...document.querySelectorAll('.filter-chip[data-filter="carnegie"].active')]
                .map(c => c.dataset.value);
            
            applyFilters();
        }

        function clearFilter(type) {
            document.querySelectorAll(`.filter-chip[data-filter="${type}"]`).forEach(c => {
                c.classList.remove('active');
            });
            
            if (type === 'state') {
                document.getElementById('stateFilter').value = '';
                filters.state = '';
            } else {
                filters[type] = [];
            }
            
            applyFilters();
        }

        function applyFilters() {
            filteredData = allData.filter(d => {
                // Radius filter
                if (radiusCenter) {
                    const distance = calculateDistance(radiusCenter.lat, radiusCenter.lng, d.lat, d.lng);
                    d.distanceFromCenter = distance;
                    if (distance > selectedRadius) return false;
                }

                // Program/CIP filter
                if (filters.programs.length > 0) {
                    const hasMatchingProgram = filters.programs.some(selectedCip => {
                        return d.cipCodes.some(instCip => Math.floor(instCip) === selectedCip);
                    });
                    if (!hasMatchingProgram) return false;
                }

                // Control type
                if (filters.control.length > 0 && !filters.control.includes(String(d.control))) {
                    return false;
                }

                // Degree level - check if highest degree offered is at or above selected
                if (filters.degree.length > 0) {
                    const degreeMatch = filters.degree.some(deg => {
                        const degVal = parseInt(deg);
                        // For doctoral (9), match 9+; for master's (7), match 7-9; etc.
                        return d.hloffer >= degVal;
                    });
                    if (!degreeMatch) return false;
                }

                // Locale
                if (filters.locale.length > 0) {
                    const localeMatch = filters.locale.some(loc => {
                        if (loc === 'city') return d.locale >= 11 && d.locale <= 13;
                        if (loc === 'suburb') return d.locale >= 21 && d.locale <= 23;
                        if (loc === 'town') return d.locale >= 31 && d.locale <= 33;
                        if (loc === 'rural') return d.locale >= 41 && d.locale <= 43;
                        return false;
                    });
                    if (!localeMatch) return false;
                }

                // Size
                if (filters.size.length > 0 && !filters.size.includes(String(d.instsize))) {
                    return false;
                }

                // Special designations
                if (filters.special.length > 0) {
                    const specialMatch = filters.special.some(s => {
                        if (s === 'hbcu') return d.hbcu === 1;
                        if (s === 'tribal') return d.tribal === 1;
                        if (s === 'landgrant') return d.landgrant === 1;
                        if (s === 'medical') return d.medical === 1;
                        return false;
                    });
                    if (!specialMatch) return false;
                }

                // Carnegie
                if (filters.carnegie.length > 0) {
                    const carnegieMatch = filters.carnegie.some(c => {
                        if (c === '15') return d.c21basic === 15;
                        if (c === '16') return d.c21basic === 16;
                        if (c === 'master') return d.c21basic >= 18 && d.c21basic <= 20;
                        if (c === 'bacc') return d.c21basic >= 21 && d.c21basic <= 23;
                        return false;
                    });
                    if (!carnegieMatch) return false;
                }

                // State
                if (filters.state && d.state !== filters.state) {
                    return false;
                }

                // Min enrollment
                if (d.enrollment < filters.minEnrollment) {
                    return false;
                }

                // Min completions
                if (d.completions < filters.minCompletions) {
                    return false;
                }

                return true;
            });

            // Sort by distance if radius is active
            if (radiusCenter) {
                filteredData.sort((a, b) => a.distanceFromCenter - b.distanceFromCenter);
            }

            renderMarkers();
            updateStats();
            updateRadiusStatus();
        }

        function renderMarkers() {
            markersLayer.clearLayers();

            const metric = document.getElementById('bubbleMetric').value;
            const maxVal = Math.max(...filteredData.map(d => d[metric] || 1));

            filteredData.forEach(d => {
                const value = d[metric] || 0;
                const radius = Math.max(4, Math.sqrt(value / maxVal) * 25);

                let color;
                if (d.control === 1) color = '#3b82f6'; // Public - blue
                else if (d.control === 2) color = '#14b8a6'; // Private NP - teal
                else color = '#8b5cf6'; // Private FP - purple

                const marker = L.circleMarker([d.lat, d.lng], {
                    radius: radius,
                    fillColor: color,
                    fillOpacity: 0.6,
                    color: color,
                    weight: 1,
                    opacity: 0.8
                });

                // Popup content
                let popupContent = `
                    <div class="popup-title">${d.name}</div>
                    <div class="popup-location">${d.city}, ${d.state}</div>
                    <div class="popup-stats">
                        <div class="popup-stat">
                            <div class="popup-stat-value">${formatNumber(d.enrollment)}</div>
                            <div class="popup-stat-label">Enrollment</div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-value">${formatNumber(d.completions)}</div>
                            <div class="popup-stat-label">Completions</div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-value">${formatCurrency(d.tuition_in)}</div>
                            <div class="popup-stat-label">In-State</div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-value">${formatCurrency(d.tuition_out)}</div>
                            <div class="popup-stat-label">Out-of-State</div>
                        </div>
                    </div>
                `;

                if (d.distanceFromCenter !== undefined) {
                    popupContent += `
                        <div class="popup-distance">
                            üìç ${d.distanceFromCenter.toFixed(1)} miles from center
                        </div>
                    `;
                }

                // Show matching programs if filter is active
                if (filters.programs.length > 0 && d.cipCodes.length > 0) {
                    const matchingPrograms = filters.programs
                        .filter(selectedCip => d.cipCodes.some(instCip => Math.floor(instCip) === selectedCip))
                        .map(cip => cipCategories[cip]?.name || `CIP ${cip}`)
                        .slice(0, 3);
                    
                    if (matchingPrograms.length > 0) {
                        popupContent += `
                            <div class="popup-programs">
                                <div class="popup-programs-title">üìö Matching Programs</div>
                                ${matchingPrograms.join(', ')}${matchingPrograms.length < filters.programs.filter(selectedCip => d.cipCodes.some(instCip => Math.floor(instCip) === selectedCip)).length ? '...' : ''}
                            </div>
                        `;
                    }
                }

                marker.bindPopup(popupContent);
                markersLayer.addLayer(marker);
            });
        }

        function updateStats() {
            const count = filteredData.length;
            const totalEnrollment = filteredData.reduce((sum, d) => sum + d.enrollment, 0);
            const publicCount = filteredData.filter(d => d.control === 1).length;
            const privateCount = filteredData.filter(d => d.control === 2 || d.control === 3).length;
            const avgEnrollment = count > 0 ? Math.round(totalEnrollment / count) : 0;
            
            const tuitionData = filteredData.filter(d => d.tuition_in > 0);
            const avgTuition = tuitionData.length > 0 
                ? Math.round(tuitionData.reduce((sum, d) => sum + d.tuition_in, 0) / tuitionData.length)
                : 0;

            const states = new Set(filteredData.map(d => d.state)).size;

            // Header stats
            document.getElementById('headerInstitutions').textContent = formatNumber(count);
            document.getElementById('headerEnrollment').textContent = formatNumber(totalEnrollment);
            document.getElementById('headerStates').textContent = states;

            // Results counter
            document.getElementById('resultsCount').textContent = formatNumber(count);

            // Summary cards
            document.getElementById('summaryInstitutions').textContent = formatNumber(count);
            document.getElementById('summaryStudents').textContent = formatNumber(totalEnrollment);
            document.getElementById('summaryPublic').textContent = formatNumber(publicCount);
            document.getElementById('summaryPrivate').textContent = formatNumber(privateCount);
            document.getElementById('summaryAvgEnrollment').textContent = formatNumber(avgEnrollment);
            document.getElementById('summaryAvgTuition').textContent = formatCurrency(avgTuition);
        }

        function updateRadiusStatus() {
            const statusEl = document.getElementById('radiusStatus');
            
            if (radiusCenter) {
                document.getElementById('radiusLocationName').textContent = radiusCenter.name;
                document.getElementById('radiusCount').textContent = formatNumber(filteredData.length);
                statusEl.classList.add('active');
            } else {
                statusEl.classList.remove('active');
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function formatCurrency(num) {
            if (!num || num === 0) return '‚Äî';
            return '$' + num.toLocaleString();
        }

        function exportCSV() {
            const headers = [
                'UNITID', 'Institution Name', 'City', 'State', 'Control',
                'Enrollment', 'FTE', 'Undergraduate', 'Graduate', 'Completions',
                'In-State Tuition', 'Out-of-State Tuition', 'Latitude', 'Longitude', 'CIP Codes'
            ];

            if (radiusCenter) {
                headers.push('Distance (miles)');
            }

            const rows = filteredData.map(d => {
                const row = [
                    d.unitid,
                    `"${d.name}"`,
                    `"${d.city}"`,
                    d.state,
                    d.control === 1 ? 'Public' : d.control === 2 ? 'Private Non-Profit' : 'Private For-Profit',
                    d.enrollment,
                    d.fte,
                    d.undergraduate,
                    d.graduate,
                    d.completions,
                    d.tuition_in,
                    d.tuition_out,
                    d.lat,
                    d.lng,
                    '"' + (d.cipCodes || []).join('; ') + '"'
                ];
                
                if (radiusCenter) {
                    row.push(d.distanceFromCenter?.toFixed(1) || '');
                }
                
                return row.join(',');
            });

            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ipeds_filtered_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
